- name: install kvm dependencies
  become: true
  apt:
    name: "{{ packages }}"
  vars:
    packages:
      - libvirt-clients
      - libvirt-daemon-system
      - libvirt-daemon
      - virtinst
      - bridge-utils
      - qemu
      - qemu-system-x86
      - virt-manager

- name: create directory for home pool
  file:
    path: /home/{{ ansible_user }}/.libvirtimages
    state: directory
    mode: 0755
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: create home pool
  command: virsh pool-define-as --name home --type dir --target /home/{{ ansible_user }}/.libvirtimages
  ignore_errors: true

- name: set home pool to autostart
  command: virsh pool-autostart home

- name: start home pool
  command: virsh pool-start home
  ignore_errors: true

- name: Enable audio
  become: true
  ansible.builtin.lineinfile:
    path: /etc/libvirt/qemu.conf
    regexp: ".*vnc_allow_host_audio = [01].*"
    line: vnc_allow_host_audio = 1

- name: Restart service
  become: true
  ansible.builtin.systemd:
    state: restarted
    daemon_reload: yes
    name: libvirtd
