---

 - name: install packages
   become: yes
   apt:
     name: "{{ packages }}"
     state: present
   vars:
     packages:
     - build-essential
     - libssl-dev
     - curl

 - name: install nvm
   become: yes
   git:
   args:
     repo: https://github.com/nvm-sh/nvm.git
     dest: "{{ nvm_dir }}"
     version: "v{{ nvm_version }}"

 - name: set permissions on nvm directory
   become: yes
   file:
     path: "{{ nvm_dir }}"
     state: directory
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     recurse: true
   changed_when: False

 - name: follow symlink to nvm directory
   shell: readlink -f {{ nvm_dir }}
   register: nvm_dir_install
   changed_when: False

 - name: install lts node version and latest npm version
   shell: "source {{ nvm_dir_install.stdout }}/nvm.sh && nvm install --lts --latest-npm"
   args:
     executable: /bin/bash
   register: nvm_install_result
   changed_when: "'is already installed.' not in nvm_install_result.stdout and 'is already installed.' not in nvm_install_result.stderr"

 - name: alias default node
   shell: "source {{ nvm_dir_install.stdout }}/nvm.sh && nvm alias default $(nvm current)"
   args:
     executable: /bin/bash

 - name: ensure user profile directory exists
   become: yes
   ansible.builtin.file:
     dest: /home/{{ ansible_user }}/.profile.d
     state: directory
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0755

 - name: define user nvm variables
   become: yes
   template:
     src: user_nvm.sh.j2
     dest: /home/{{ ansible_user }}/.profile.d/nvm.sh
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0755
