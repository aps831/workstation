---

 - name: install apt key
   become: yes
   apt_key:
     url: 'https://packages.cloud.google.com/apt/doc/apt-key.gpg'
     state: present

 - name: install repo
   become: yes
   apt_repository:
     repo: deb https://packages.cloud.google.com/apt cloud-sdk main
     filename: gcloud
     state: present

 - name: install packages
   become: yes
   apt:
     name: "{{ packages }}"
     state: present
   vars:
     packages:
     - google-cloud-sdk
     - kubectl
     - bash-completion

 - name: create temp file for kubectl completion
   become: yes
   ansible.builtin.tempfile:
     state: file
   register: kubectl_completion_file
   changed_when: false

 - name: create kubectl shell completion
   become: yes
   shell: /usr/bin/kubectl completion bash > {{ kubectl_completion_file.path }}
   changed_when: false

 - name: install kubectl completion
   become: yes
   ansible.builtin.copy:
     src: "{{ kubectl_completion_file.path }}"
     dest: /etc/bash_completion.d/kubectl
     owner: root
     group: root
     mode: 0644
     remote_src: yes
