---
 - name: install python
   become: yes
   apt:
     name: "{{ packages }}"
   vars:
     packages:
     - python3-apt
     - python3-distutils
     - python3-dev
     - python3-venv
     - python3-pip
     # pyenv dependencies
     - make
     - build-essential
     - libssl-dev
     - zlib1g-dev
     - libbz2-dev
     - libreadline-dev
     - libsqlite3-dev
     - wget
     - curl
     - llvm
     - libncursesw5-dev
     - xz-utils
     - tk-dev
     - libxml2-dev
     - libxmlsec1-dev
     - libffi-dev
     - liblzma-dev

# pyenv
 - name: create pyenv folder
   become: yes
   file:
     path: "{{ pyenv_install_dir }}"
     state: directory
     mode: 0755
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"

 - name: get latest tag name
   uri:
     url: "{{ pyenv_latest_tag_url }}"
     return_content: yes
   register: release_content

 - name: output version
   ansible.builtin.debug:
     msg: "Using version {{ release_content.json.tag_name }}"

 - name: install pyenv
   git:
   args:
     repo: "{{ pyenv_download_url }}"
     dest: "{{ pyenv_install_dir }}"
     version: "{{ release_content.json.tag_name }}"

 - name: set system as global version
   copy:
     src: "version"
     dest: "{{ pyenv_install_dir }}/version"
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0644

# python dependencies
 - name: install python dependencies
   pip:
    name:
     - setuptools=={{ setuptools_version }}
     - testresources=={{ testresources_version }}

# pipenv
 - name: install pipenv
   pip:
     name: pipenv
     version: "{{ pipenv_version }}"

# profile
 - name: ensure user profile directory exists
   become: yes
   ansible.builtin.file:
     dest: /home/{{ ansible_user }}/.profile.d
     state: directory
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0755

 - name: define pyenv variables
   become: yes
   template:
     src: user_pyenv.sh.j2
     dest: /home/{{ ansible_user }}/.profile.d/pyenv.sh
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0755

 - name: define pipenv variables
   become: yes
   template:
     src: user_pipenv.sh.j2
     dest: /home/{{ ansible_user }}/.profile.d/pipenv.sh
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0755
