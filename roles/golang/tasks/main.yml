---

#
# System Go
#
 - name: test if version already installed
   become: yes
   ansible.builtin.stat:
     path: "/usr/local/go-{{ golang_version }}"
   register: golang_install_dir

 - name: create temporary build directory
   tempfile:
     state: directory
     suffix: build
   register: tmp_dir
   when: golang_install_dir.stat.isdir is not defined
   changed_when: false

 - name: download golang
   become: yes
   get_url:
     url: "{{ golang_download_url }}"
     checksum: "sha256:{{ golang_checksum }}"
     dest: "{{ tmp_dir.path }}"
   when: golang_install_dir.stat.isdir is not defined

 - name: create directory for installation
   become: yes
   ansible.builtin.file:
    path: "/usr/local/go-{{ golang_version }}"
    state: directory
    mode: '0755'

 - name: unpack golang
   become: yes
   unarchive:
     src: "{{ tmp_dir.path }}/{{ golang_download_filename }}"
     dest: "/usr/local/go-{{ golang_version }}"
     remote_src: yes
     owner: root
     group: root
     mode: 0755
   when: golang_install_dir.stat.isdir is not defined

 - name: create symbolic link
   become: yes
   file:
     src: "/usr/local/go-{{ golang_version }}/go"
     dest: "/usr/local/go"
     state: link
     mode: '0755'

 - name: define global golang variables
   become: yes
   template:
     src: etc_golang.sh.j2
     dest: /etc/profile.d/golang.sh
     mode: 0755

#
# Goenv
#

 - name: create goenv folder
   become: yes
   file:
     path: "{{ goenv_install_dir }}"
     state: directory
     mode: 0755
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"

 - name: install goenv
   git:
   args:
     repo: "{{ goenv_download_url }}"
     dest: "{{ goenv_install_dir }}"
     version: "{{ goenv_version }}"

 - name: ensure user profile directory exists
   become: yes
   ansible.builtin.file:
     dest: /home/{{ ansible_user }}/.profile.d
     state: directory
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0755

 - name: define user golang variables
   become: yes
   template:
     src: user_golang.sh.j2
     dest: /home/{{ ansible_user }}/.profile.d/golang.sh
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0755

 - name: set system as global version
   copy:
     src: "version"
     dest: "{{ goenv_install_dir }}/version"
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0644
