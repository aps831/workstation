---

 - name: install haproxy
   become: yes
   apt:
     name: haproxy
     state: present

 - name: adding '{{ haproxy_user }}' user to group ssl-cert
   become: yes
   user:
    name: '{{ haproxy_user }}'
    groups: ssl-cert
    append: yes

 - name: create directory for config
   become: yes
   file:
     path: /etc/haproxy
     state: directory

 - name: create haproxy config
   become: yes
   template:
     src: haproxy.cfg.j2
     dest: /etc/haproxy/haproxy.cfg
     mode: 0444
     validate: haproxy -f %s -c -q
   notify: restart haproxy

 - name: create systemd service
   become: yes
   template:
     src: haproxy.service.j2
     dest: /etc/systemd/system/haproxy.service
   notify: restart haproxy

 - name: enable service at boot
   become: yes
   systemd:
     name: haproxy
     enabled: yes

 - name: "allow connections from {{ haproxy_ufw_allow_host }}"
   become: yes
   ufw:
     rule: allow
     src: "{{ haproxy_ufw_allow_host }}"
     port: "{{ haproxy_docker_external_port }}"
