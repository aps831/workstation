---

 - name: install packages
   become: yes
   apt:
     name: "{{ packages }}"
   vars:
     packages:
      - curl
      - apt-transport-https
      - gnupg

 - name: create directory for scripts
   become: yes
   file:
     path: /usr/share/systemd
     state: directory

 - name: create script for service
   become: yes
   template:
     src: jenkins.sh.j2
     dest: /usr/share/systemd/jenkins.sh
     owner: "{{ jenkins_user }}"
     group: "{{ jenkins_user }}"
     mode: 0744
   notify: restart jenkins

 - name: check if jenkins is already installed
   become: yes
   stat:
     path: "{{ jenkins_user_home }}/jenkins/jenkins.war"
   register: jenkins_war

 - name: create jenkins folder
   become: yes
   file:
     path: "{{ jenkins_user_home }}/jenkins"
     state: directory
     owner: "{{ jenkins_user }}"
     group: "{{ jenkins_user }}"
     mode: 0755

 - name: download jenkins
   become: yes
   get_url:
     url: "{{ jenkins_war_url }}"
     dest: "{{ jenkins_user_home }}/jenkins"
     owner: "{{ jenkins_user }}"
     group: "{{ jenkins_user }}"
   when: not jenkins_war.stat.exists

 - name: create jenkins log folder
   become: yes
   file:
     path: "{{ jenkins_user_home }}/jenkins/log"
     state: directory
     owner: "{{ jenkins_user }}"
     group: "{{ jenkins_user }}"
     mode: 0755

 - name: create jenkins cache folder
   become: yes
   file:
     path: "/var/cache/jenkins/war"
     state: directory
     owner: "{{ jenkins_user }}"
     group: "{{ jenkins_user }}"
     mode: 0755

 - name: create systemd service
   become: yes
   template:
     src: jenkins.service.j2
     dest: /etc/systemd/system/jenkins.service
   notify: restart jenkins

 - name: enable service at boot
   become: yes
   systemd:
     name: jenkins
     enabled: yes

 - name: "allow connections from {{ jenkins_ufw_allow_host }}"
   become: yes
   ufw:
     rule: allow
     src: "{{ jenkins_ufw_allow_host }}"
     port: "{{ jenkins_http_port }}"     
