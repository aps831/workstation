---

 - name: add repository
   become: yes
   apt_repository:
     repo: ppa:git-core/ppa
     codename: "{{ ubuntu_codename }}"
     state: present
     update_cache: yes

 - name: install git
   become: yes
   apt:
     name: git
     state: present

 - name: install bash-completion
   become: yes
   apt:
     name: bash-completion
     state: present

 - name: download git completion
   become: yes
   get_url:
     url: https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash
     dest: /etc/bash_completion.d/git-completion
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0444

 - name: download git-flow completion
   become: yes
   get_url:
     url: https://raw.githubusercontent.com/bobthecow/git-flow-completion/master/git-flow-completion.bash
     dest: /etc/bash_completion.d/git-flow-completion
     owner: "{{ ansible_user }}"
     group: "{{ ansible_user }}"
     mode: 0444

 - name: download git secrets
   get_url:
     url: "{{ git_secrets_download_url }}"
     dest: "{{ git_secrets_download_tmp }}"
   changed_when: false

 - name: Create temporary build directory
   ansible.builtin.tempfile:
     state: directory
     suffix: build
   register: temp_dir

 - name: extract from archive
   become: yes
   unarchive:
     src: "{{ git_secrets_download_tmp }}"
     dest: "{{ temp_dir.path }}"
     remote_src: yes
     extra_opts: [--strip-components=1]
     mode: 0744

 - name: install git secrets
   become: yes
   command: make install
   args:
     chdir: "{{ temp_dir.path }}"

 - name: set permissions on git secrets
   become: yes
   file:
     path: /usr/local/bin/git-secrets
     mode: 0777
