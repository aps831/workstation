---

 - name: install backup packages
   become: yes
   apt:
     name: "{{ packages }}"
   vars:
     packages:
     - duplicity
     - duply
     - python-boto
     - cron
     - timeshift

 - name: "create directory for {{ backup_name }} backup logs"
   become: yes
   file:
     path: "/var/log/duply/{{ backup_name }}_backup"
     state: directory
     owner: root
     group: root
     mode: u=rw,g=r,o=r
     recurse: yes

 - name: "create directory for {{ backup_name }} backup test logs"
   become: yes
   file:
     path: "/var/log/duply/{{ backup_name }}_backup_test"
     state: directory
     owner: root
     group: root
     mode: u=rw,g=r,o=r
     recurse: yes

 - name: "install {{ backup_name }} backup script"
   become: yes
   template:
     src: "backup.sh.j2"
     dest: "/usr/local/sbin/{{ backup_name }}_backup.sh"
     owner: root
     group: root
     mode: u+rwx,g-rwx,o-rwx

 - name: "install {{ backup_name }} backup test script"
   become: yes
   template:
     src: "test.sh.j2"
     dest: "/usr/local/sbin/{{ backup_name }}_backup_test.sh"
     owner: root
     group: root
     mode: u+rwx,g-rwx,o-rwx

 - name: "install {{ backup_name }} backup service"
   become: yes
   template:
     src: "backup.service.j2"
     dest: "/etc/systemd/system/{{ backup_name }}_backup.service"
     owner: root
     group: root
     mode: 0666

 - name: "install {{ backup_name }} backup timer"
   become: yes
   template:
     src: "backup.timer.j2"
     dest: "/etc/systemd/system/{{ backup_name }}_backup.timer"
     owner: root
     group: root
     mode: 0666

 - name: "install {{ backup_name }} backup test service"
   become: yes
   template:
     src: "test.service.j2"
     dest: "/etc/systemd/system/{{ backup_name }}_backup_test.service"
     owner: root
     group: root
     mode: 0666

 - name: "install {{ backup_name }} backup test timer"
   become: yes
   template:
     src: "test.timer.j2"
     dest: "/etc/systemd/system/{{ backup_name }}_backup_test.timer"
     owner: root
     group: root
     mode: 0666

 - name: enable {{ backup_name }} backup service
   become: yes
   systemd:
     name: "{{ backup_name }}_backup"
     enabled: yes
    
 - name: enable {{ backup_name }} backup timer
   become: yes
   systemd:
     name: "{{ backup_name }}_backup.timer"
     state: started
     enabled: yes

 - name: enable {{ backup_name }} backup test service
   become: yes
   systemd:
     name: "{{ backup_name }}_backup_test"
     enabled: yes

 - name: enable {{ backup_name }} backup test timer
   become: yes
   systemd:
     name: "{{ backup_name }}_backup_test.timer"
     state: started
     enabled: yes
